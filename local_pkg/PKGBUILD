# Maintainer: fireice <your_email>
pkgname=zero-kelvin-stazis-git
pkgver=$(grep '^version =' ../Cargo.toml | cut -d '"' -f 2)
pkgrel=1
pkgdesc="Cold storage backup utility (Rust port)"
arch=('x86_64')
url="https://github.com/Antony-hash512/Zero-Kelvin-Stazis"
license=('GPL3')
depends=('glibc' 'gcc-libs' 'squashfs-tools' 'squashfs-tools-ng' 'cryptsetup' 'squashfuse' 'rclone' 'util-linux')
makedepends=('cargo' 'git' 'fish' 'bats' 'just') # Добавил тестовые зависимости
provides=('zero-kelvin-stazis' 'zks-rs' 'squash_manager-rs')
conflicts=('zero-kelvin-stazis')

source=()
md5sums=()

prepare() {
    # Локальная копия текущей папки разработки
    mkdir -p "$srcdir/$pkgname"
    # Копируем всё, кроме тяжелой папки target и скрытых директорий git
    rsync -a --exclude='target' --exclude='.git' --exclude='local_pkg' ../ "$srcdir/$pkgname/"
}

build() {
    cd "$srcdir/$pkgname"
    export RUSTUP_TOOLCHAIN=stable
    cargo build --release --locked
}

check() {
    cd "$srcdir/$pkgname"
    # Запуск тестов, как в вашем черновике.
    # Важно: makepkg запускает это в чистом окружении, убедитесь, что just/fish доступны
    # Если тесты требуют root (LUKS), они тут упадут или будут пропущены.
    cargo test --release --locked
    # just build-and-shell-tests-release # Можно включить, если там нет sudo-тестов
}

package() {
    cd "$srcdir/$pkgname"
    install -Dm755 target/release/squash_manager-rs "$pkgdir/usr/bin/squash_manager-rs"
    install -Dm755 target/release/zks-rs "$pkgdir/usr/bin/zks-rs"

    # Устанавливаем лицензию (обязательно для GPL в Arch, если файл в корне)
    install -Dm644 LICENSE.GPLv3 "$pkgdir/usr/share/licenses/$pkgname/LICENSE.GPLv3"
    install -Dm644 README.md "$pkgdir/usr/share/licenses/$pkgname/README.md"
}

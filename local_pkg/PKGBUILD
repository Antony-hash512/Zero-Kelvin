# Maintainer: fireice <your_email>
pkgname=zero-kelvin-stazis-git
pkgver=$(grep '^version =' ../Cargo.toml | cut -d '"' -f 2)
pkgrel=1
pkgdesc="Cold storage backup utility (Rust port)"
arch=('x86_64')
url="https://github.com/Antony-hash512/Zero-Kelvin-Stazis"
license=('GPL3')
depends=('glibc' 'gcc-libs' 'squashfs-tools' 'squashfs-tools-ng' 'cryptsetup' 'squashfuse' 'rclone' 'util-linux')
makedepends=('cargo' 'git' 'fish' 'bats' 'just') # Добавил тестовые зависимости
provides=('zero-kelvin-stazis' 'zks-rs' 'squash_manager-rs')
conflicts=('zero-kelvin-stazis')

# Абсолютный путь к корню проекта (вычисляется при парсинге PKGBUILD)
# Нужен, чтобы избежать конфликта имён: папка src проекта vs папка src от makepkg
_projectdir="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

source=()
md5sums=()

prepare() {
    # 1. Очищаем целевую папку
    rm -rf "$srcdir/$pkgname"
    mkdir -p "$srcdir/$pkgname"
   
    # 2. Копируем файлы из корня проекта (Cargo.toml, Justfile, *.md)
    # Используем find с maxdepth 1, чтобы взять только файлы
    #find "$_projectdir" -maxdepth 1 -type f -not -name '.*' -exec cp -t "$srcdir/$pkgname/" {} +
    
    # 3. Копируем нужные папки ЯВНО
    # Это гарантирует, что мы не скопируем случайно local_pkg, target или .git
    cp -r "$_projectdir/src" "$srcdir/$pkgname/"
    cp -r "$_projectdir/tests" "$srcdir/$pkgname/"
    cp -r "$_projectdir/Cargo.toml" "$srcdir/$pkgname/"
    cp -r "$_projectdir/Cargo.lock" "$srcdir/$pkgname/"
    cp -r "$_projectdir/Justfile" "$srcdir/$pkgname/"
    cp -r "$_projectdir/README.md" "$srcdir/$pkgname/"
    cp -r "$_projectdir/LICENSE.GPLv3" "$srcdir/$pkgname/"
    
    echo "DEBUG: Copied source structure:"
    ls -F "$srcdir/$pkgname/"
}




build() {
    cd "$srcdir/$pkgname"
    export RUSTUP_TOOLCHAIN=stable
    # Явно указываем папку для артефактов внутри временного каталога
    export CARGO_TARGET_DIR="target"
    cargo build --release --locked
}

check() {
    cd "$srcdir/$pkgname"
    export CARGO_TARGET_DIR="target"
    cargo test --release --locked
    
    # 2. Запуск интеграционных тестов на бинарниках, которые мы только что собрали
    # Используем --no-build-release, так как release-бинарники уже собраны в этапе build()
    fish tests/run_shell_tests.fish --no-build-release --no-root
}

package() {
    cd "$srcdir/$pkgname"
    install -Dm755 target/release/squash_manager-rs "$pkgdir/usr/bin/squash_manager-rs"
    install -Dm755 target/release/zks-rs "$pkgdir/usr/bin/zks-rs"

    # Установка лицензии и документации
    install -Dm644 LICENSE.GPLv3 "$pkgdir/usr/share/licenses/$pkgname/LICENSE.GPLv3"
    install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
}

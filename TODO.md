# План портирования Zero-Kelvin-Stazis на Rust

## Этап 1: Подготовка и Каркас (Skeleton)
- [x] **Настройка Cargo:**
    - [x] Обновить `Cargo.toml` (секции `[[bin]]`, `[lib]`, зависимости).
    - [x] Убедиться, что все необходимые зависимости добавлены.
- [x] **Базовая структура проекта:**
    - [x] Создать файлы модулей (`lib.rs`, `engine.rs` и др.) согласно структуре в GEMINI.md.
    - [x] Создать заглушки для бинарников `bin/zks-rs.rs` и `bin/squash_manager-rs.rs`.
    - [x] Реализовать флаги `-h`/`--help` и `-V`/`--version` (автоматически через clap).
- [x] **CLI Парсинг (Clap):**
    - [x] Реализовать структуру аргументов для `squash_manager-rs` (create, mount, umount).
    - [x] Реализовать структуру аргументов для `zks-rs` (freeze, unfreeze, check).
    - [x] Настроить инициализацию `env_logger` в точках входа.

## Этап 2: Ядро (Core Library)
- [x] **Command Executor (Mocking):**
    - [x] Реализовать трейт `CommandExecutor` и структуру `RealSystem` (реальный вызов `std::process::Command`).
    - [x] Реализовать `DryRun` или `MockSystem` для тестов (запись команд в буфер).
- [x] **Манифест (Manifest):**
    - [x] Реализовать структуры `Manifest` и `FileEntry` (используя Serde).
    - [x] Реализовать сериализацию/десериализацию и парсинг `list.yaml` (включая legacy).


## Этап 3: Squash Manager (Фундамент)
- [x] Разворачивание среды для интеграционных shell-тестов
- [x] **Команда `create`:**
    - [x] Интеграционные shell-тесты для `create`
    - [x] Сборка команды `mksquashfs` (флаги сжатия, исключения).
    - [x] Реализация флага `-c`/`--compression`, и заглушки для `-e`/`--encrypt`.
    - [?] Обработка прогресс-бара и флага `--no-progress`.

## Этап 4: Squash Manager (Mount/Umount)

- [x] **Интеграционные shell-тесты**
    - [x] Реализовать тесты для `squash_manager-rs mount` (без прав рута т.к под капотом используется squashfuse)
    - [x] Реализовать тесты для `squash_manager-rs mount` с автоматической генерацией имени каталога монтирования, если он не указан
    - [x] Реализовать тесты для `squash_manager-rs umount`
    - [x] Реализовать тест(ы) для `squash_manager-rs umount` с указанием образа вместо каталога монтирования
    - [x] Добавить тест для `squash_manager-rs create` с проверкой через file, что созданнай файл это squashfs-образ
- [x] **Код на Rust**
    - [x] Реализовать дополнительные юнит-тесты для `squash_manager-rs mount`/`squash_manager-rs umount` (если актуально)
    - [x] Реализовать успешное прохождение всех тестов для `squash_manager-rs mount`/`squash_manager-rs umount`  
    - [x] Обновить справочную информацию для `squash_manager-rs umount` описав новые возможности:
        - [x] автоматическая генерация имени каталога монтирования для `squash_manager-rs mount`
        - [x] указания образа вместо каталога его монтирования для `squash_manager-rs umount`
        - [x] улучшить структуру справочной информации (реализованы стандарты CLI и справки)
    
## Этап 5: Squash Manager (Полная реализация)
- [x] Реализовать проверку прав суперпользователя (через `utils.rs`):
    -  [x] Юнит-тесты
    -  [x] Реализация функционала

- [x] **Новый функционал**
    - [x] Внедрить перепаковку архивов вместо работы с обычными каталогами для форматов поверх tar'а: 7z, zip, gzip, bzip2, xz, zstd, rar + сам tar, перепаковку надо делать через пайп, без создания промежуточных файлов
        - [x] Интеграционные shell-тесты
        - [x] Реализация прохождения тестов
        - [x] Обновить справочную информацию для `squash_manager-rs create` описав новые возможности
        - [x] Рализовать негативные тесты в 04_unpack.bats (нет утилиты, для распаковки, файл повреждён или неизвестный формат)
    - [x] Внедрить LUKS-шифрование в squash_manager-rs:
        - [x] Рализовать логику пропуска тестов, требующих прав рута в зависимости от условий (по утверждённому плану)
        - [x] Реализовать интеграционные shell-тесты для:
            - [x] Внедрения LUKS-шифрования в squash_manager-rs:
            - [x] Реализации truncate для сброса неиспользуемого места в конце LUKS-контейнера, используя File::set_len()
            - [x] Реализация удаления мусора после успешного завершения операции: не должно оставаться маппированных LUKS-контейнеров
            - [x] Реализация удаления мусора, если операция была прервана: кроме LUKS-контейнера нужно удалить не дописанный до конца squashfs-образ
        - [x] Реализовать в Rust-коде mock юнит-тесты эмуляции работы с LUKS с правами root, без реального рута
        - [x] Реализация прохождения всех тестов
        - [?] Обновление справочной информации для `squash_manager-rs create` описав новые возможности
- [x] Вместо `df -T` используем `stat` 
- [x] Собрать пакет и протестить руками
- [ ] Допил во время ручного тестирования
    - [x] Обновить отображение прогресс-бара для `squash_manager-rs create`
    - [x] Очистка при прерывании не только для каталогов, но для архивов
    - [x] Исправить баг с прогресс-баром (когда показывет O байт, хотя процесс идет)
    - [x] теперь `-e` используется только для каталогов (отказ от перепаковки архивов из-за I/O ошибок на ext4)
    - [x] Добавить прогресс-бар в LUKS-режим (Native по умолчанию, Custom через --alfa-progress)
    - [x] Реализовать удаление недописанного файла при Ctrl+C для LUKS-режима
    - [ ] Устранение багов (mount/umount) LUKS-режима
 


    

## Этап 6: ZKS Logic - Freeze (Создание)
- [ ] Ручная переработка TODO-листов для этапов 6+ (не выполняем задачи этапов 6+ автоматически пока данный пункт не выполнен)
- [ ] **Подготовка данных:**
    - [ ] Генерация `list.yaml` на основе аргументов.
    - [ ] Создание временной структуры каталогов.
- [ ] **Упаковка:**
    - [ ] Оркестрация вызова `squash_manager-rs create`.
    - [ ] Поддержка режимов `plain` и `LUKS`.

    - [ ] Реализация чтения списка целей из файла (`-r` / `--read`).

## Этап 7: ZKS Logic - Unfreeze (Восстановление)
- [ ] **Чтение sqfs-образа:**
    - [ ] Монтирование образа (через `squash_manager mount`).
    - [ ] Чтение и валидация `list.yaml` из смонтированного образа.
- [ ] **Восстановление:**
    - [ ] Логика копирования файлов из `to_restore/<number>` в реальные пути (`original_path` или `restore_path`).
    - [ ] Обработка конфликтов (если файл уже существует).
- [ ] **Cleanup:** Корректное размонтирование и очистка.

## Этап 8: ZKS Logic - Check (Проверка целостности)
- [ ] **Чтение архива:**
    - [ ] Монтирование образа (через `squash_manager mount`).
    - [ ] Чтение `list.yaml` из точки монтирования.
- [ ] **Проверка файлов:**
    - [ ] Реализация быстрой рекурсивной проверки по всему дереву через точный размер в байтах.
    - [ ] Реализация флала --use-cmp для побайтового сравнения.
    - [ ] Реализация флага --force-delete  (удаление локальных копий при совпадении).
    - [ ] Вывод отчета о целостности (отсутствующие/изменённые файлы).

## Этап 9: Интеграционные тесты и Полировка
- [ ] **Smoke Tests:**
    - [ ] Написать тест на полный цикл: создание файла -> freeze -> удаление оригинала через check --force-delete -> unfreeze -> сравнение хеш-сумм через check --use-cmp.
- [ ] **Error Handling:**
    - [ ] Проверить/реализовать юзер-френдли сообщения об ошибках (отсутствие места, неверный пароль).


## Этапы 10: Новый фукционал
- [ ] Реализация режима Streaming Mode (`--direct-rclone`) т.е. rclone при через сеть, без необходимости монтирования сетевого каталога.
- [ ] Внедрение зависимости libguestfs (утилита guestfish) для поддержки, dd-дампов и дисков различных виртуальных машин.
- [ ] См. "временные решения" в GEMINI.md
- [ ] Добавить генерацию man страниц через clap_mangen и build.rs
# План портирования Zero-Kelvin-Stazis на Rust

## Этап 1: Подготовка и Каркас (Skeleton)
- [ ] **Настройка Cargo:**
    - [ ] Обновить `Cargo.toml`: добавить секции `[[bin]]` для двух бинарников (`zks-rs` и `squash_manager-rs`).
    - [ ] Убедиться, что все зависимости (`clap`, `anyhow`, `serde`, `indicatif`) добавлены.
- [ ] **Базовая структура проекта:**
    - [ ] Создать файлы модулей: `engine.rs`, `executor.rs`, `manifest.rs`, `utils.rs`.
    - [ ] Настроить `main.rs` (для zks) и создать `bin/squash_manager.rs` (или аналогичную точку входа).
- [ ] **CLI Парсинг (Clap):**
    - [ ] Реализовать структуру аргументов для `zks-rs` (команды freeze, unfreeze, check).
    - [ ] Реализовать структуру аргументов для `squash_manager-rs` (create, mount, umount).
    - [ ] Настроить логирование (`env_logger`).

## Этап 2: Ядро (Core Library)
- [ ] **Command Executor (Mocking):**
    - [ ] Реализовать трейт `CommandExecutor` в `executor.rs`.
    - [ ] Реализовать `RealSystem` (реальный вызов `std::process::Command`).
    - [ ] Реализовать `DryRun` или `MockSystem` для тестов (запись команд в буфер).
- [ ] **Манифест (Manifest):**
    - [ ] Описать структуры `Manifest` и `FileEntry` в `manifest.rs` (используя `serde`).
    - [ ] Реализовать сериализацию/десериализацию YAML.
    - [ ] Добавить тесты на парсинг `list.yaml` (включая legacy формат).

## Этап 3: Squash Manager (Фундамент)
- [ ] **Реализация `create` (Plain):**
    - [ ] Сборка команды `mksquashfs` с правильными флагами сжатия (`-comp zstd`).
    - [ ] Обработка прогресс-бара (чтение stderr от mksquashfs или использование `indicatif` поверх).
- [ ] **Реализация `mount` / `umount`:**
    - [ ] Обертки над системными `mount` и `umount`.
    - [ ] Проверка прав суперпользователя (через `utils.rs`).

## Этап 4: ZKS Logic - Freeze (Создание)
- [ ] **Подготовка данных:**
    - [ ] Генерация `list.yaml` на основе переданных аргументов.
    - [ ] Создание временной структуры каталогов (`to_restore/1/...`) во временной папке (`tempfile`).
    - [ ] Hardlinks/Copy: Эффективное копирование файлов во временную структуру перед упаковкой.
- [ ] **Упаковка:**
    - [ ] Вызов `squash_manager-rs create` для упаковки временной директории.
    - [ ] Реализация режима `plain/LUKS` (шифрование) через флаг `-e` (передача управления в squash_manager).
- [ ] **Тесты:**
    - [ ] Unit-тест: Проверка генерации YAML.
    - [ ] Unit-тест: Проверка аргументов, передаваемых в squash_manager (через Mock).

## Этап 5: ZKS Logic - Unfreeze (Восстановление)
- [ ] **Чтение архива:**
    - [ ] Монтирование образа (через `squash_manager mount`).
    - [ ] Чтение `list.yaml` из точки монтирования.
- [ ] **Восстановление:**
    - [ ] Логика копирования файлов из `to_restore/X` в реальные пути (`original_path` или `restore_path`).
    - [ ] Обработка конфликтов (если файл уже существует).
- [ ] **Cleanup:** Размонтирование образа.

## Этап 6: Интеграционные тесты и Полировка
- [ ] **Smoke Tests:**
    - [ ] Написать тест на полный цикл: создание файла -> freeze -> удаление оригинала -> unfreeze -> сравнение хеш-сумм.
- [ ] **Error Handling:**
    - [ ] Проверить красивые сообщения об ошибках (отсутствие места, неверный пароль).
- [ ] **Документация:**
    - [ ] Обновить README.md (если требуется).

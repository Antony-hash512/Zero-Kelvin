# План портирования Zero-Kelvin-Stazis на Rust

## Этап 1: Подготовка и Каркас (Skeleton)
- [x] **Настройка Cargo:**
    - [x] Обновить `Cargo.toml` (секции `[[bin]]`, `[lib]`, зависимости).
    - [x] Убедиться, что все необходимые зависимости добавлены.
- [x] **Базовая структура проекта:**
    - [x] Создать файлы модулей (`lib.rs`, `engine.rs` и др.) согласно структуре в GEMINI.md.
    - [x] Создать заглушки для бинарников `bin/zks-rs.rs` и `bin/squash_manager-rs.rs`.
    - [x] Реализовать флаги `-h`/`--help` и `-V`/`--version` (автоматически через clap).
- [x] **CLI Парсинг (Clap):**
    - [x] Реализовать структуру аргументов для `squash_manager-rs` (create, mount, umount).
    - [x] Реализовать структуру аргументов для `zks-rs` (freeze, unfreeze, check).
    - [x] Настроить инициализацию `env_logger` в точках входа.

## Этап 2: Ядро (Core Library)
- [x] **Command Executor (Mocking):**
    - [x] Реализовать трейт `CommandExecutor` и структуру `RealSystem` (реальный вызов `std::process::Command`).
    - [x] Реализовать `DryRun` или `MockSystem` для тестов (запись команд в буфер).
- [x] **Манифест (Manifest):**
    - [x] Реализовать структуры `Manifest` и `FileEntry` (используя Serde).
    - [x] Реализовать сериализацию/десериализацию и парсинг `list.yaml` (включая legacy).


## Этап 3: Squash Manager (Фундамент)
- [x] Разворачивание среды для интеграционных shell-тестов
- [x] **Команда `create`:**
    - [x] Интеграционные shell-тесты для `create`
    - [x] Сборка команды `mksquashfs` (флаги сжатия, исключения).
    - [x] Реализация флага `-c`/`--compression`, и заглушки для `-e`/`--encrypt`.
    - [?] Обработка прогресс-бара и флага `--no-progress`.

## Этап 4: Squash Manager (Mount/Umount)

- [x] **Интеграционные shell-тесты**
    - [x] Реализовать тесты для `squash_manager-rs mount` (без прав рута т.к под капотом используется squashfuse)
    - [x] Реализовать тесты для `squash_manager-rs mount` с автоматической генерацией имени каталога монтирования, если он не указан
    - [x] Реализовать тесты для `squash_manager-rs umount`
    - [x] Реализовать тест(ы) для `squash_manager-rs umount` с указанием образа вместо каталога монтирования
    - [x] Добавить тест для `squash_manager-rs create` с проверкой через file, что созданнай файл это squashfs-образ
- [ ] **Код на Rust**
    - [x] Реализовать дополнительные юнит-тесты для `squash_manager-rs mount`/`squash_manager-rs umount` (если актуально)
    - [x] Реализовать успешное прохождение всех тестов для `squash_manager-rs mount`/`squash_manager-rs umount`  
    - [x] Обновить справочную информацию для `squash_manager-rs umount` описав новые возможности:
        - [x] автоматическая генерация имени каталога монтирования для `squash_manager-rs mount`
        - [x] указания образа вместо каталога его монтирования для `squash_manager-rs umount`
        - [x] улучшить структуру справочной информации (реализованы стандарты CLI и справки)
    
## Этап 5: Squash Manager (Полная реализация)
- [ ] Реализовать проверку прав суперпользователя (через `utils.rs`):
    -  [ ] Юнит-тесты
    -  [ ] Реализация функционала

- [ ] **Новый функционал**
    - [ ] Внедрение LUKS-шифрования в squash_manager-rs:
        - [ ] Интеграционные shell-тесты
        - [ ] Реализация прохождения тестов
    - [ ] Реализовать truncate для сброса неиспользуемого места в конце LUKS-контейнера, используя File::set_len()
        - [ ] Интеграционные shell-тесты
        - [ ] Реализация прохождения тестов
    - [ ] Внедрить перепаковку архивов вместо работы с обычными каталогами (если это ещё не реализовано)
        - [ ] Интеграционные shell-тесты
        - [ ] Реализация прохождения тестов

## Этап 6: ZKS Logic - Freeze (Создание)
- [ ] **Подготовка данных:**
    - [ ] Генерация `list.yaml` на основе аргументов.
    - [ ] Создание временной структуры каталогов.
- [ ] **Упаковка:**
    - [ ] Оркестрация вызова `squash_manager-rs create`.
    - [ ] Поддержка режимов `plain` и `LUKS`.

    - [ ] Реализация чтения списка целей из файла (`-r` / `--read`).

## Этап 7: ZKS Logic - Unfreeze (Восстановление)
- [ ] **Чтение sqfs-образа:**
    - [ ] Монтирование образа (через `squash_manager mount`).
    - [ ] Чтение и валидация `list.yaml` из смонтированного образа.
- [ ] **Восстановление:**
    - [ ] Логика копирования файлов из `to_restore/<number>` в реальные пути (`original_path` или `restore_path`).
    - [ ] Обработка конфликтов (если файл уже существует).
- [ ] **Cleanup:** Корректное размонтирование и очистка.

## Этап 8: ZKS Logic - Check (Проверка целостности)
- [ ] **Чтение архива:**
    - [ ] Монтирование образа (через `squash_manager mount`).
    - [ ] Чтение `list.yaml` из точки монтирования.
- [ ] **Проверка файлов:**
    - [ ] Реализация быстрой рекурсивной проверки по всему дереву через точный размер в байтах.
    - [ ] Реализация флала --use-cmp для побайтового сравнения.
    - [ ] Реализация флага --force-delete  (удаление локальных копий при совпадении).
    - [ ] Вывод отчета о целостности (отсутствующие/изменённые файлы).

## Этап 9: Интеграционные тесты и Полировка
- [ ] **Smoke Tests:**
    - [ ] Написать тест на полный цикл: создание файла -> freeze -> удаление оригинала через check --force-delete -> unfreeze -> сравнение хеш-сумм через check --use-cmp.
- [ ] **Error Handling:**
    - [ ] Проверить/реализовать юзер-френдли сообщения об ошибках (отсутствие места, неверный пароль).


## Этап 10: Новый фукционал
- [ ] Реализация режима Streaming Mode (`--direct-rclone`) т.е. rclone при через сеть, без необходимости монтирования сетевого каталога.

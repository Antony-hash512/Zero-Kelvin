# План портирования Zero-Kelvin-Stazis на Rust

## Этап 1: Подготовка и Каркас (Skeleton)
- [x] **Настройка Cargo:**
    - [x] Обновить `Cargo.toml` (секции `[[bin]]`, `[lib]`, зависимости).
    - [ ] Убедиться, что все необходимые зависимости добавлены.
- [x] **Базовая структура проекта:**
    - [x] Создать файлы модулей (`lib.rs`, `engine.rs` и др.) согласно структуре в GEMINI.md.
    - [x] Создать заглушки для бинарников `bin/zks-rs.rs` и `bin/squash_manager-rs.rs`.
    - [x] Реализовать флаги `-h`/`--help` и `-V`/`--version` (автоматически через clap).
- [x] **CLI Парсинг (Clap):**
    - [x] Реализовать структуру аргументов для `squash_manager-rs` (create, mount, umount).
    - [x] Реализовать структуру аргументов для `zks-rs` (freeze, unfreeze, check).
    - [x] Настроить инициализацию `env_logger` в точках входа.

## Этап 2: Ядро (Core Library)
- [x] **Command Executor (Mocking):**
    - [x] Реализовать трейт `CommandExecutor` и структуру `RealSystem` (реальный вызов `std::process::Command`).
    - [x] Реализовать `DryRun` или `MockSystem` для тестов (запись команд в буфер).
- [x] **Манифест (Manifest):**
    - [x] Реализовать структуры `Manifest` и `FileEntry` (используя Serde).
    - [x] Реализовать сериализацию/десериализацию и парсинг `list.yaml` (включая legacy).

## Этап 3: Squash Manager (Фундамент)
- [ ] **Команда `create`:**
    - [ ] Сборка команды `mksquashfs` (флаги сжатия, исключения).
    - [ ] Реализация флагов `-c`/`--compression` и `-e`/`--encrypt`.
    - [ ] Обработка прогресс-бара и флага `--no-progress`.
- [ ] **Команды `mount` / `umount`:**
    - [ ] Обертки над системными вызовами mount/umount.
    - [ ] Проверка прав суперпользователя (через `utils.rs`).

- [ ] **Тестирование в ручном режиме (для человека)**
    - [ ] Вручную протестировать готовый собранный бинарник
    - [ ] Если всё ок, отметить все чекбоксы данного этапа

## Этап 4: ZKS Logic - Freeze (Создание)
- [ ] **Подготовка данных:**
    - [ ] Генерация `list.yaml` на основе аргументов.
    - [ ] Создание временной структуры каталогов.
- [ ] **Упаковка:**
    - [ ] Оркестрация вызова `squash_manager-rs create`.
    - [ ] Поддержка режимов `plain` и `LUKS`.
    - [ ] Реализовать truncate для сброса неиспользуемого места в конце LUKS-контейнера, используя File::set_len()
    - [ ] Реализация чтения списка целей из файла (`-r` / `--read`).

## Этап 5: ZKS Logic - Unfreeze (Восстановление)
- [ ] **Чтение sqfs-образа:**
    - [ ] Монтирование образа (через `squash_manager mount`).
    - [ ] Чтение и валидация `list.yaml` из смонтированного образа.
- [ ] **Восстановление:**
    - [ ] Логика копирования файлов из `to_restore/<number>` в реальные пути (`original_path` или `restore_path`).
    - [ ] Обработка конфликтов (если файл уже существует).
- [ ] **Cleanup:** Корректное размонтирование и очистка.

## Этап 6: ZKS Logic - Check (Проверка целостности)
- [ ] **Чтение архива:**
    - [ ] Монтирование образа (через `squash_manager mount`).
    - [ ] Чтение `list.yaml` из точки монтирования.
- [ ] **Проверка файлов:**
    - [ ] Релизация быстрой рекурсивной проверки по всему дереву через точный размер в байтах.
    - [ ] Реализация флала --use-cmp для побайтового сравнения.
    - [ ] Реализация флага --force-delete  (удаление локальных копий при совпадении).
    - [ ] Вывод отчета о целостности (отсутствующие/изменённые файлы).

## Этап 7: Интеграционные тесты и Полировка
- [ ] **Smoke Tests:**
    - [ ] Написать тест на полный цикл: создание файла -> freeze -> удаление оригинала через check --force-delete -> unfreeze -> сравнение хеш-сумм через check --use-cmp.
- [ ] **Error Handling:**
    - [ ] Проверить/реализовать юзер-френдли сообщения об ошибках (отсутствие места, неверный пароль).


## Этап 8: Новый фукционал
- [ ] Реализация режима Streaming Mode (`--direct-rclone`) т.е. rclone при через сеть, без необходимости монтирования сетевого каталога.
